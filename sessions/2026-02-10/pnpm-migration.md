# Session: Migrate from npm to pnpm

**Date:** 2026-02-10
**Duration context:** Medium

## What was accomplished

- Fully migrated the monorepo from npm workspaces to pnpm workspaces
- Created `pnpm-workspace.yaml` for pnpm workspace resolution
- Updated root `package.json`: `packageManager` field, workspace-filter scripts, `pnpm.onlyBuiltDependencies` allowlist, added `@prisma/client` to root deps
- Converted all 12 internal workspace dependency references from `"*"` to `"workspace:*"` across every `package.json`
- Fixed 3 phantom dependencies exposed by pnpm's strict `node_modules` isolation
- Configured `turbopack.root` in `next.config.ts` to resolve lockfile ambiguity
- Updated `CLAUDE.md` (stack description + all development commands) and `README.md` (getting started)
- Deleted `package-lock.json` (root + mcp-server) and all `node_modules`
- Generated `pnpm-lock.yaml` via fresh `pnpm install`
- Verified: all 135 tests pass, Next.js + MCP server build succeeds, workspace filter commands work

## Key decisions & rationale

- **`workspace:*` protocol for all internal deps:** pnpm requires this to recognize local packages; without it, pnpm tries to fetch `@nasty-plot/*` from the npm registry
- **`@prisma/client` added to root `package.json`:** The generated Prisma client lives at `generated/prisma/` (repo root) and imports `@prisma/client/runtime/*`. Under pnpm's strict isolation, this must be resolvable from the root `node_modules`
- **`pnpm.onlyBuiltDependencies` instead of interactive `pnpm approve-builds`:** pnpm 10 blocks postinstall scripts by default for security. The declarative config in `package.json` is CI-friendly and doesn't require interactive approval
- **`turbopack.root` set explicitly:** A stale `~/pnpm-lock.yaml` in the home directory caused Next.js/Turbopack to infer the wrong workspace root, breaking module resolution

## Bugs found & fixed

- **Phantom dep: `@pkmn/dex` missing from `packages/analysis`** — `threat.service.ts` and `analysis.service.ts` imported it without declaring it. Worked with npm's flat hoisting, failed with pnpm. Added to `dependencies`
- **Phantom dep: `@smogon/calc` missing from `packages/battle-engine`** — `greedy-ai.ts` and `heuristic-ai.ts` imported it. Added to `dependencies`
- **Phantom dep: `@types/react` missing from `packages/ui`** — TypeScript couldn't find React type declarations. The types were only in `apps/web/devDependencies`. Added to `packages/ui/devDependencies`
- **Prisma client runtime resolution failure** — `generated/prisma/internal/class.ts` imports `@prisma/client/runtime/client` and WASM modules. Under pnpm, these weren't accessible from the repo root. Fixed by adding `@prisma/client` to root deps

## Pitfalls & gotchas encountered

- **`corepack enable pnpm` needs sudo** on macOS when Node is installed globally. Fortunately pnpm was already available via Homebrew
- **pnpm `approve-builds` is interactive** — can't be used in non-interactive contexts. The `pnpm.onlyBuiltDependencies` field in `package.json` is the correct declarative approach
- **Turbopack lockfile detection walks up the directory tree** — a `pnpm-lock.yaml` in `~/` (from an unrelated project) caused Turbopack to pick the home directory as the workspace root, breaking all module resolution. The `turbopack.root` config option fixes this
- **pnpm strict isolation catches real dependency bugs** — 3 phantom dependencies that silently worked under npm were immediately caught. This is a feature, not a bug

## Files changed

- `pnpm-workspace.yaml` — **created** (workspace definition)
- `package.json` (root) — packageManager, scripts, added `@prisma/client`, `pnpm.onlyBuiltDependencies`
- `apps/web/package.json` — workspace protocol for all `@nasty-plot/*` deps
- `apps/web/next.config.ts` — added `turbopack.root`
- `packages/analysis/package.json` — workspace protocol + added `@pkmn/dex`
- `packages/battle-engine/package.json` — workspace protocol + added `@smogon/calc`
- `packages/core/package.json` — (name only, no deps to update)
- `packages/damage-calc/package.json` — workspace protocol
- `packages/data-pipeline/package.json` — workspace protocol
- `packages/db/package.json` — (no workspace deps)
- `packages/formats/package.json` — workspace protocol
- `packages/llm/package.json` — workspace protocol
- `packages/pokemon-data/package.json` — workspace protocol
- `packages/recommendations/package.json` — workspace protocol
- `packages/smogon-data/package.json` — workspace protocol
- `packages/teams/package.json` — workspace protocol
- `packages/ui/package.json` — workspace protocol + added `@types/react`
- `CLAUDE.md` — stack description, all dev commands updated to pnpm
- `README.md` — rewritten with pnpm commands and proper project description
- `package-lock.json` — **deleted** (root)
- `packages/mcp-server/package-lock.json` — **deleted**
- `pnpm-lock.yaml` — **created** (generated by pnpm install)

## Known issues & next steps

- **ESLint peer dependency warnings:** eslint 10 is installed but several plugins only support up to eslint 9. Pre-existing issue, not caused by migration. Should update eslint plugins or pin eslint to 9
- **Stale `~/pnpm-lock.yaml`:** There's a `pnpm-lock.yaml` in the user's home directory from an unrelated project. While `turbopack.root` works around it, cleaning it up would be ideal
- **`msw` build script not approved:** msw's postinstall was excluded from `onlyBuiltDependencies`. If MSW is used for testing, it may need to be added

## Tech notes

- **pnpm `workspace:*` protocol:** Required for all internal monorepo dependencies. Without it, pnpm resolves from the npm registry instead of linking local packages. The `*` means "any version from the workspace"
- **`pnpm.onlyBuiltDependencies`:** pnpm 10+ blocks postinstall/preinstall scripts by default. This allowlist in root `package.json` permits specific packages to run build scripts (Prisma, native modules like better-sqlite3, esbuild, sharp)
- **Prisma generated output at repo root:** Because `prisma generate` outputs to `generated/prisma/` at the monorepo root (not inside any package), `@prisma/client` must be a root dependency so the generated code can resolve its runtime imports
- **`turbopack.root`:** Set to `path.join(__dirname, "../..")` in `apps/web/next.config.ts` to explicitly point at the monorepo root. Without this, Turbopack walks up looking for lockfiles and can pick the wrong directory
