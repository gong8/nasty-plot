generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Format {
  id         String   @id // e.g. "gen9ou"
  name       String   // e.g. "OU"
  generation Int
  gameType   String   // "singles" | "doubles"
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  usageStats    UsageStats[]
  smogonSets    SmogonSet[]
  teammateCorrs TeammateCorr[]
  checkCounters CheckCounter[]
  moveUsages    MoveUsage[]
  itemUsages    ItemUsage[]
  abilityUsages AbilityUsage[]
  teams         Team[]
}

model UsageStats {
  id           Int    @id @default(autoincrement())
  formatId     String
  pokemonId    String
  usagePercent Float
  rank         Int
  year         Int
  month        Int

  format Format @relation(fields: [formatId], references: [id])

  @@unique([formatId, pokemonId, year, month])
  @@index([formatId, rank])
  @@index([pokemonId])
}

model SmogonSet {
  id        Int    @id @default(autoincrement())
  formatId  String
  pokemonId String
  setName   String
  ability   String
  item      String
  nature    String
  teraType  String?
  moves     String  // JSON array e.g. ["Earthquake", ["Ice Punch", "Stone Edge"]]
  evs       String  // JSON object e.g. {"hp": 252, "atk": 252, "spe": 4}
  ivs       String? // JSON object, null = all 31

  format Format @relation(fields: [formatId], references: [id])

  @@unique([formatId, pokemonId, setName])
  @@index([formatId, pokemonId])
}

model TeammateCorr {
  id                 Int    @id @default(autoincrement())
  formatId           String
  pokemonAId         String
  pokemonBId         String
  correlationPercent Float

  format Format @relation(fields: [formatId], references: [id])

  @@unique([formatId, pokemonAId, pokemonBId])
  @@index([formatId, pokemonAId])
}

model CheckCounter {
  id            Int    @id @default(autoincrement())
  formatId      String
  targetId      String
  counterId     String
  koPercent     Float
  switchPercent Float

  format Format @relation(fields: [formatId], references: [id])

  @@unique([formatId, targetId, counterId])
  @@index([formatId, targetId])
}

model Team {
  id         String   @id @default(uuid())
  name       String
  formatId   String
  mode       String   @default("freeform") // "freeform" | "guided"
  notes      String?
  parentId   String?
  branchName String?
  isArchived Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  format         Format        @relation(fields: [formatId], references: [id])
  slots          TeamSlot[]
  chatSessions   ChatSession[]
  battlesAsTeam1 Battle[]      @relation("BattleTeam1")
  battlesAsTeam2 Battle[]      @relation("BattleTeam2")
  parent         Team?         @relation("TeamLineage", fields: [parentId], references: [id], onDelete: SetNull)
  children       Team[]        @relation("TeamLineage")

  @@index([parentId])
}

model TeamSlot {
  id        Int    @id @default(autoincrement())
  teamId    String
  position  Int // 1-6
  pokemonId String
  nickname  String?
  ability   String
  item      String
  nature    String
  teraType  String?
  level     Int    @default(100)
  move1     String
  move2     String?
  move3     String?
  move4     String?
  evHp      Int    @default(0)
  evAtk     Int    @default(0)
  evDef     Int    @default(0)
  evSpA     Int    @default(0)
  evSpD     Int    @default(0)
  evSpe     Int    @default(0)
  ivHp      Int    @default(31)
  ivAtk     Int    @default(31)
  ivDef     Int    @default(31)
  ivSpA     Int    @default(31)
  ivSpD     Int    @default(31)
  ivSpe     Int    @default(31)

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, position])
}

model DataSyncLog {
  id         Int      @id @default(autoincrement())
  source     String // "smogon-stats" | "smogon-sets"
  formatId   String
  lastSynced DateTime
  status     String // "success" | "error"
  message    String?

  @@unique([source, formatId])
}

model ChatSession {
  id          String   @id @default(uuid())
  teamId      String?
  title       String?
  contextMode String?  // "guided-builder" | "team-editor" | "battle-live" | "battle-replay"
  contextData String?  // JSON snapshot of context at session creation
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team     Team?         @relation(fields: [teamId], references: [id], onDelete: SetNull)
  messages ChatMessage[]
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  sessionId String
  role      String // "user" | "assistant" | "system"
  content   String
  toolCalls String? // JSON
  createdAt DateTime @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model Battle {
  id           String   @id @default(uuid())
  formatId     String
  gameType     String   // "singles" | "doubles"
  mode         String   // "play" | "analyze" | "batch"
  aiDifficulty String?
  team1Paste   String
  team1Name    String   @default("Player")
  team2Paste   String
  team2Name    String   @default("Opponent")
  team1Id      String?
  team2Id      String?
  winnerId     String?  // "team1" | "team2" | "draw"
  turnCount    Int      @default(0)
  protocolLog  String   // raw @pkmn/sim protocol
  commentary   String?  // JSON Record<number, string> — turn → commentary text
  batchId      String?
  createdAt    DateTime @default(now())

  team1 Team?            @relation("BattleTeam1", fields: [team1Id], references: [id], onDelete: SetNull)
  team2 Team?            @relation("BattleTeam2", fields: [team2Id], references: [id], onDelete: SetNull)
  batch BatchSimulation? @relation(fields: [batchId], references: [id], onDelete: Cascade)
  turns BattleTurn[]

  @@index([batchId])
  @@index([createdAt])
}

model BattleTurn {
  id            Int    @id @default(autoincrement())
  battleId      String
  turnNumber    Int
  team1Action   String // JSON BattleAction
  team2Action   String
  stateSnapshot String // JSON compact state (HP%, field, conditions)
  winProbTeam1  Float?

  battle Battle @relation(fields: [battleId], references: [id], onDelete: Cascade)

  @@unique([battleId, turnNumber])
  @@index([battleId])
}

model BatchSimulation {
  id             String   @id @default(uuid())
  formatId       String
  gameType       String
  aiDifficulty   String
  team1Paste     String
  team1Name      String   @default("Team 1")
  team2Paste     String
  team2Name      String   @default("Team 2")
  totalGames     Int
  completedGames Int      @default(0)
  team1Wins      Int      @default(0)
  team2Wins      Int      @default(0)
  draws          Int      @default(0)
  status         String   @default("pending") // pending|running|completed|cancelled
  analytics      String?  // JSON BatchAnalytics
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  battles Battle[]

  @@index([status])
}

model SampleTeam {
  id         String   @id @default(uuid())
  name       String
  formatId   String
  archetype  String?  // rain, sun, stall, balance, hyper-offense, etc.
  source     String?  // smogon-forums, tournament, usage-generated
  sourceUrl  String?
  paste      String
  pokemonIds String   // comma-separated for LIKE queries
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@index([formatId])
  @@index([formatId, archetype])
}

model MoveUsage {
  id           Int    @id @default(autoincrement())
  formatId     String
  pokemonId    String
  moveName     String
  usagePercent Float

  format Format @relation(fields: [formatId], references: [id])

  @@unique([formatId, pokemonId, moveName])
  @@index([formatId, pokemonId])
}

model ItemUsage {
  id           Int    @id @default(autoincrement())
  formatId     String
  pokemonId    String
  itemName     String
  usagePercent Float

  format Format @relation(fields: [formatId], references: [id])

  @@unique([formatId, pokemonId, itemName])
  @@index([formatId, pokemonId])
}

model AbilityUsage {
  id           Int    @id @default(autoincrement())
  formatId     String
  pokemonId    String
  abilityName  String
  usagePercent Float

  format Format @relation(fields: [formatId], references: [id])

  @@unique([formatId, pokemonId, abilityName])
  @@index([formatId, pokemonId])
}
